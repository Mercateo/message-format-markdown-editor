<!doctype html>
<head>
  <meta charset="UTF-8">
	<title>MessageFormat Live Preview</title>
  <!--Messageformat-->
	<script src='bower_components/messageformat/messageformat.js'></script>
  <script src='bower_components/messageformat/locale/de.js'></script>
  <script src='bower_components/messageformat/locale/en.js'></script>
  <script src='bower_components/messageformat/locale/fr.js'></script>
	<script src='messageFormatPreview.js'></script>
  <!--Codemirror-->
	<script src="bower_components/codemirror/lib/codemirror.js"></script>
	<link  href="bower_components/codemirror/lib/codemirror.css" rel="stylesheet">
	<script src="messageformat.js"></script>

  <script src="bower_components/codemirror/addon/edit/matchbrackets.js"></script>
  <script src="bower_components/codemirror/addon/edit/closebrackets.js"></script>

  <script src="bower_components/codemirror/addon/lint/lint.js"></script>
  <link rel="stylesheet" href="bower_components/codemirror/addon/lint/lint.css">
  <script src="bower_components/codemirror.messageformat/forgiving-messageformat-parser.js"></script>
  <script src="bower_components/codemirror.messageformat/messageformat-lint.js"></script>
  <!--Markdown-->
  <script src="bower_components/marked/marked.min.js"></script>
  <!---JQuery & Bootstrap-->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <link  href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.0/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.0/js/bootstrap-toggle.min.js"></script>
  <style>
    .CodeMirror {
      max-height: 150px; /* the minimum height */
    }
    .toggle.btn {
      float:right;
      margin-top:10px;
    }
    .well {
      margin: 20px;
    }
  </style>
</head>
<body>
  <div class='container-fluid'>
    <table class='table table-bordered' style='table-layout:fixed'>
      <tr class='info'>
        <th width='25%'>Info</th>
        <th width='25%'>DE</th>
        <th width='25%'>EN</th>
        <th width='25%'>FR</th>
      </tr>
      <tr class='0'>
        <td style="height:150px">
          <div class ='row'>
            <div class ='col-md-9'>
              <h4>basket.cluster_badge_description&nbsp;<small>basket-strings</small></h4>
              <h5><small>Zuletzt geändert: <span class='lastChanged'>07.07.15</span></small></h5><br>
            </div>
            <div class='col-md-3'>
              <input type="checkbox" id='toggle-0' data-toggle="toggle" data-on='Vorschau' data-off='Vorschau' data-onstyle='success' data-offstyle='default'>
            </div>
          </div>
          <pre class='comment'>COLOR: [weiß|schwarz]</pre>
        </td>
        <td style='padding:0px'>
      	   <textarea class="de 0">Ein Cluster enthält alle Artikel, die bestimmte Anforderungen erfüllen (z. B. Kopierpapier, DIN A4, 80 g/m², weiß).</textarea>    
           <div class='preview de 0'></div>
        </td>
        <td style='padding:0px'>
             <textarea class="en 0">A Cluster contains all items that fulfil certain requirements (e. g. copy paper, DIN A4, 80 g/m², 
{COLOR, select,
  weiß {white}
    other {black}
}).</textarea>      
           <div class='preview en 0'></div>
        </td>
        <td style='padding:0px'>
             <textarea class="fr 0">Un cluster contient tous les produits répondant à des besoins spécifiques (papier pour imprimante, format A4, 80g/m2, 
{COLOR, select,
  weiß {blanc}
    other {noir}
}).</textarea>      
           <div class='preview fr 0'></div>
        </td>
      </tr>
      <tr class='1'>
        <td>
          <div class ='row'>
            <div class ='col-md-9'>
              <h4>basket.cluster_badge_description&nbsp;<small>basket-strings</small></h4>
              <h5><small>Zuletzt geändert: <span class='lastChanged'>07.07.15</span></small></h5><br>
            </div>
            <div class='col-md-3'>
              <input type="checkbox" id='toggle-1' data-toggle="toggle" data-on='Vorschau' data-off='Vorschau' data-onstyle='success' data-offstyle='default'>
            </div>
          </div>
          <pre class='comment'>AGB_URL
DSE_LINK: Datenschutzerklärung</pre>
        </td>
        <td style='padding:0px'>
           <textarea class="de 1">Ja, ich bestätige die [AGB]({AGB_URL}) und die [Datenschutzerklärung]({DSE_LINK}) der Mercateo AG.</textarea>      
           <div class='preview de 1'></div>
        </td>
        <td style='padding:0px'>
             <textarea class="en 1">Yes, I confirm the [General Terms and Conditions]({AGB_URL}) and the [data protection notice]({DSE_LINK}) of Mercateo</textarea>      
           <div class='preview en 1'></div>
        </td>
        <td style='padding:0px'>
             <textarea class="fr 1">Oui, j'accepte les [conditions générales de vente]({AGB_URL}) et la [déclaration de confidentialité]({DSE_LINK}) de Mercateo France SAS</textarea>      
           <div class='preview fr 1'></div>
        </td>
      </tr>
    </table>
	<script type="text/javascript">
    var locales = ['de','en','fr'];
    var editorInstances;
    $(function(){

      editorInstances = $('textarea').map(function(index,ta){
        return CodeMirror.fromTextArea(ta, {
          mode: "messageformat.js",
          lineNumbers: true,
          styleActiveLine: true,
          lint: true,
          gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"],
          lineWrapping: true,
          viewportMargin: Infinity
        });
      })

      $("[type=checkbox]").change(function(){
        var row = $(this).parent().parent().parent().parent().parent()

        var editors = row.find('.CodeMirror')
        var previews = row.find('.preview')

        for (var i = 0; i < 3; i++){
          if (this.checked){
            renderPreview(editorInstances[parseInt(row.attr('class'))*3+i].getValue(),previews[i],row.find('.comment').html(), locales[i]);
            $(editors[i]).hide();
            $(previews[i]).show();
          }
          else {
            $(editors[i]).show();
            $(previews[i]).hide();
          }
        }
      })

      var renderPreview = function(from,to,comment, locale){
        var whitespace = from.replace(/\n\n\n/g,'<br/></br>').replace(/\n\n/g,'<br/>').replace(/\s+/g,' ');
        var renderer = new marked.Renderer();
        renderer.paragraph = function(string){return string.replace(/&#/g,'&\\#')+"<br/>\n"};
        var md = marked(whitespace,{renderer: renderer});
        // remove trailing <br/> 
        md = md.substring(0,md.length-6);
        var samples = generateSamples(locale,md,comment);
        $(to).html("<div class='well'>"+samples.join("</div><div class='well'>")+"</div>");
      }
    })
  </script>    
</body>
</html>